/*! ToSic_ToSxc 2015-05-07 */

!function(){var a=angular.module("2sxc.view",["2sxc.api"]);a.controller("TemplateSelectorCtrl",["$scope","$attrs","moduleApiService","$filter","$q","$window",function(a,b,c,d,e,f){var g=b.moduleid,h=c(g);a.manageInfo=$2sxc(g).manage._manageInfo,a.apps=[],a.contentTypes=[],a.templates=[],a.filteredTemplates=function(b){return a.manageInfo.isContentApp?d("filter")(a.templates,"_LayoutElement"==b?{ContentTypeStaticName:""}:{ContentTypeStaticName:b},!0):a.templates},a.contentTypeId=a.manageInfo.contentTypeId,a.templateId=a.manageInfo.templateId,a.savedTemplateId=a.manageInfo.templateId,a.appId=a.manageInfo.appId,a.savedAppId=a.manageInfo.appId,a.loading=0,a.reloadTemplates=function(){a.loading++;var b=h.getSelectableContentTypes(),c=h.getSelectableTemplates();e.all([b,c]).then(function(b){a.contentTypes=b[0].data,a.templates=b[1].data,d("filter")(a.templates,{ContentTypeStaticName:""},!0).length>0&&(a.contentTypes.push({StaticName:"_LayoutElement",Name:"Layout element"}),a.contentTypes=d("orderBy")(a.contentTypes,"Name")),a.loading--})},a.$watch("templateId",function(b,c){if(b!=c)if(a.manageInfo.isContentApp)a.renderTemplate(b);else{a.loading++;var d;d=a.manageInfo.hasContent?a.saveTemplateId(b):a.setPreviewTemplateId(b),d.then(function(){f.location.reload()})}}),a.$watch("contentTypeId",function(b,c){if(b!=c){var d=a.filteredTemplates(b)[0].TemplateId;a.templateId!=d&&null!=d&&(a.templateId=d)}}),null!=a.appId&&a.manageInfo.templateChooserVisible&&a.reloadTemplates(),a.$watch("manageInfo.templateChooserVisible",function(b,c){b!=c&&null!=a.appId&&b&&a.reloadTemplates()}),a.$watch("appId",function(a,c){return a!=c&&null!=a?-1==a?void(window.location=b.importappdialog):void h.setAppId(a).then(function(){f.location.reload()}):void 0}),a.manageInfo.isContentApp||h.getSelectableApps().then(function(c){a.apps=c.data,a.apps.push({Name:b.importapptext,AppId:-1})}),a.setTemplateChooserState=function(b){return b||(a.templateId=a.savedTemplateId),h.setTemplateChooserState(b).then(function(){a.manageInfo.templateChooserVisible=b})},a.saveTemplateId=function(){var b=[];return a.manageInfo.hasContent&&a.savedTemplateId==a.templateId||(b.push(h.saveTemplateId(a.templateId)),a.savedTemplateId=a.templateId,b.push(a.setTemplateChooserState(!1))),e.all(b)},a.setPreviewTemplateId=function(){return h.setPreviewTemplateId(a.templateId)},a.renderTemplate=function(b){a.loading++,h.renderTemplate(b).then(function(b){try{a.insertRenderedTemplate(b.data),$2sxc(g).manage._processToolbars()}catch(c){console.log("Error while rendering template:"),console.log(c)}a.loading--})},a.insertRenderedTemplate=function(a){$(".DnnModule-"+g+" .sc-viewport").html(a)},a.addItem=function(b){h.addItem(b).then(function(){a.renderTemplate(a.templateId)})},a.removeFromList=function(b){h.removeFromList(b).then(function(){a.renderTemplate(a.templateId)})},a.changeOrder=function(b,c){h.changeOrder(b,c).then(function(){a.renderTemplate(a.templateId)})}}]),a.factory("moduleApiService",["apiService",function(a){return function(b){return{saveTemplateId:function(c){return a(b,{url:"View/Module/SaveTemplateId",params:{templateId:c}})},setPreviewTemplateId:function(c){return a(b,{url:"View/Module/SetPreviewTemplateId",params:{templateId:c}})},addItem:function(c){return a(b,{url:"View/Module/AddItem",params:{sortOrder:c}})},getSelectableApps:function(){return a(b,{url:"View/Module/GetSelectableApps"})},setAppId:function(c){return a(b,{url:"View/Module/SetAppId",params:{appId:c}})},getSelectableContentTypes:function(){return a(b,{url:"View/Module/GetSelectableContentTypes"})},getSelectableTemplates:function(){return a(b,{url:"View/Module/GetSelectableTemplates"})},setTemplateChooserState:function(c){return a(b,{url:"View/Module/SetTemplateChooserState",params:{state:c}})},renderTemplate:function(c){return a(b,{url:"View/Module/RenderTemplate",params:{templateId:c}})},changeOrder:function(c,d){return a(b,{url:"View/Module/ChangeOrder",params:{sortOrder:c,destinationSortOrder:d}})},removeFromList:function(c){return a(b,{url:"View/Module/RemoveFromList",params:{sortOrder:c}})}}}}])}();
//# sourceMappingURL=2sxc.TemplateSelector.min.js.map